From 6ce693c2c7a7fce19977deea020cdb7e678f4a53 Mon Sep 17 00:00:00 2001
From: Felix Hammarstrand <felix.hammarstrand@flir.se>
Date: Wed, 13 Nov 2019 09:43:46 +0100
Subject: [PATCH] mxc mipi dsi: suspend sherlock display: enter deep standby

---
 arch/arm/boot/dts/imx7ulp-ec201.dtsi         | 2 +-
 drivers/video/fbdev/mxc/mipi_dsi_northwest.c | 6 ++++++
 2 files changed, 7 insertions(+), 1 deletion(-)

diff --git a/arch/arm/boot/dts/imx7ulp-ec201.dtsi b/arch/arm/boot/dts/imx7ulp-ec201.dtsi
index c9b5aa6..3c953d4 100644
--- a/arch/arm/boot/dts/imx7ulp-ec201.dtsi
+++ b/arch/arm/boot/dts/imx7ulp-ec201.dtsi
@@ -105,7 +105,7 @@
 	mipi_dsi_reset: mipi-dsi-reset {
 		compatible = "gpio-reset";
 		reset-gpios = <&gpio_ptc 7 GPIO_ACTIVE_LOW>;
-		reset-delay-us = <1000>;
+		reset-delay-us = <5000>;
 		#reset-cells = <0>;
 	};
 
diff --git a/drivers/video/fbdev/mxc/mipi_dsi_northwest.c b/drivers/video/fbdev/mxc/mipi_dsi_northwest.c
index cef96c6..c9458f7 100644
--- a/drivers/video/fbdev/mxc/mipi_dsi_northwest.c
+++ b/drivers/video/fbdev/mxc/mipi_dsi_northwest.c
@@ -201,6 +201,8 @@ static void mipi_dsi_set_mode(struct mipi_dsi_info *mipi_dsi,
 			      uint8_t mode);
 static int mipi_dsi_dcs_cmd(struct mipi_dsi_info *mipi_dsi,
 			    u8 cmd, const u32 *param, int num);
+static int mipi_dsi_pkt_write(struct mipi_dsi_info *mipi_dsi,
+			u8 data_type, const u32 *buf, int len);
 
 static int mipi_dsi_lcd_init(struct mipi_dsi_info *mipi_dsi,
 			     struct mxc_dispdrv_setting *setting)
@@ -778,6 +780,7 @@ static void mipi_dsi_init_interrupt(struct mipi_dsi_info *mipi_dsi)
 static int mipi_display_enter_sleep(struct mxc_dispdrv_handle *disp)
 {
 	int err;
+	char setpower[]= {0xB1,0x49,0x14,0x74,0x09,0x33,0x54,0x71,0x31,0x4D,0x2F};
 	struct mipi_dsi_info *mipi_dsi = mxc_dispdrv_getdata(disp);
 
 	err = mipi_dsi_dcs_cmd(mipi_dsi, MIPI_DCS_SET_DISPLAY_OFF,
@@ -794,6 +797,9 @@ static int mipi_display_enter_sleep(struct mxc_dispdrv_handle *disp)
 	}
 	msleep(MIPI_LCD_SLEEP_MODE_DELAY);
 
+	//Enter Deep Standby, DSTB=1
+	err = mipi_dsi_pkt_write(mipi_dsi, 0x29, (u32*)setpower, 11);
+	mipi_dsi->lcd_inited = 0;
 	return err;
 }
 
