From d277b7d88b9b7631ec19b3315ff0eb9ad7943e0c Mon Sep 17 00:00:00 2001
From: Peter Fitger <peter.fitger@flir.se>
Date: Mon, 19 Nov 2018 13:50:33 +0100
Subject: [PATCH] DT Set up for standby

PMIC added
Unneccesary RPMSG removed
---
 arch/arm/boot/dts/imx7ulp-bblc.dts | 109 ++++++++++++++++++++++++++++++++++---
 arch/arm/boot/dts/imx7ulp.dtsi     |   4 +-
 2 files changed, 103 insertions(+), 10 deletions(-)

diff --git a/arch/arm/boot/dts/imx7ulp-bblc.dts b/arch/arm/boot/dts/imx7ulp-bblc.dts
index 2dd101b..d9bc016 100644
--- a/arch/arm/boot/dts/imx7ulp-bblc.dts
+++ b/arch/arm/boot/dts/imx7ulp-bblc.dts
@@ -34,7 +34,7 @@
 
 	mipi_dsi_reset: mipi-dsi-reset {
 		compatible = "gpio-reset";
-		reset-gpios = <&gpio_ptc 19 GPIO_ACTIVE_LOW>;	// Dummy GPIO, not used
+		reset-gpios = <&gpio_ptc 18 GPIO_ACTIVE_LOW>;	// Dummy GPIO, not used
 		reset-delay-us = <1000>;
 		#reset-cells = <0>;
 	};
@@ -88,7 +88,9 @@
 		pinctrl-0 = <&pinctrl_pwm1>;
 		pinctrl-1 = <&pinctrl_pwm1>;
 	};
-	
+};
+
+&ahbbridge1 {
 	// Set up new system timer as TPM5 is used by PWM
 	tpm6: tpm@40A10000 {
 		compatible = "fsl,imx7ulp-tpm";
@@ -101,7 +103,7 @@
 };
 	
 &cpu0 {
-	arm-supply= <&dummy_reg>;
+	arm-supply= <&sw1_reg>;
 };
 
 // Disable TPM5 as it is used by PWM - we use TPM6 instead
@@ -114,6 +116,11 @@
 	assigned-clocks = <&clks IMX7ULP_CLK_LPTPM6>;
 };
 
+// Disable PWM on TPM4
+&pwm0 {
+	status = "disabled";
+};
+
 &iomuxc1 {
 	pinctrl-names = "default";
 	pinctrl-0 = <&pinctrl_hog_1>;
@@ -135,6 +142,7 @@
 			fsl,pins = <
 				IMX7ULP_PAD_PTC4__LPI2C5_SCL       0x27
 				IMX7ULP_PAD_PTC5__LPI2C5_SDA       0x27
+				IMX7ULP_PAD_PTC19__PTC19           0x3	// PMIC_INT
 			>;
 		};
 		
@@ -206,13 +214,13 @@
 
 		pinctrl_mipi_dsi_reset: mipi_dsi_reset_grp {
 			fsl,pins = <
-				IMX7ULP_PAD_PTC19__PTC19	0x3	// Dummy
+				IMX7ULP_PAD_PTC18__PTC18	0x3	// Dummy
 			>;
 		};
 		
 		pinctrl_camera: camera_grp {
 			fsl,pins = <
-//				IMX7ULP_PAD_PTF16__PTF16	0x20043  /* CAMERA CLK ENABLE*/
+				IMX7ULP_PAD_PTF16__PTF16	0x20043  /* CAMERA CLK ENABLE*/
 				IMX7ULP_PAD_PTF15__PTF15	0x20043  /* CAMERA PWDN */
 				IMX7ULP_PAD_PTF14__PTF14	0x20043  /* CAMERA RESET */
 				IMX7ULP_PAD_PTF3__VIU_PCLK	0x10043
@@ -273,8 +281,8 @@
 	
 /*  IO expander for keyboard, VCAM, Lepton, Temp sensor 1 and 2, EEPROM	*/
 &lpi2c6 {
-#address-cells = <1>;
-#size-cells = <0>;
+	#address-cells = <1>;
+	#size-cells = <0>;
 	pinctrl-names = "default", "sleep";
 	pinctrl-0 = <&pinctrl_lpi2c6>;
 	pinctrl-1 = <&pinctrl_lpi2c6>;
@@ -289,7 +297,7 @@
 		clock-names = "csi_mclk";
 		pwn-gpios = <&gpio_ptf 15 GPIO_ACTIVE_HIGH>;
 		rst-gpios = <&gpio_ptf 14 GPIO_ACTIVE_HIGH>;
-//		reset-gpios = <&gpio_ptf 16 GPIO_ACTIVE_HIGH>;	/* CLK ENABLE */
+		clk-gpios = <&gpio_ptf 16 GPIO_ACTIVE_HIGH>;
 		csi_id = <0>;
 		mclk = <24000000>;
 		mclk_source = <0>;
@@ -311,6 +319,81 @@
 	pinctrl-0 = <&pinctrl_lpi2c5>;
 	pinctrl-1 = <&pinctrl_lpi2c5>;
 	status = "okay";
+
+	pmic: pf1550@08 {
+		compatible = "fsl,pf1550";
+		interrupt-parent = <&gpio_ptc>;
+		interrupts = <19 IRQ_TYPE_EDGE_FALLING>;
+		reg = <0x08>;
+
+		onkey {
+			compatible = "fsl,pf1550-onkey";
+			linux,keycode = <KEY_POWER>;
+			wakeup;
+		};
+
+		charger {
+			compatible = "fsl,pf1550-charger";
+		};
+
+		regulators {
+			compatible = "fsl,pf1550-regulator";
+
+			sw1_reg: SW1 {
+				regulator-name = "SW1";
+				regulator-min-microvolt = <600000>;
+				regulator-max-microvolt = <1387500>;
+				regulator-boot-on;
+				regulator-always-on;
+				regulator-ramp-delay = <6250>;
+			};
+
+			sw2_reg: SW2 {
+				regulator-name = "SW2";
+				regulator-min-microvolt = <600000>;
+				regulator-max-microvolt = <1387500>;
+				regulator-boot-on;
+				regulator-always-on;
+			};
+
+			sw3_reg: SW3 {
+				regulator-name = "SW3";
+				regulator-min-microvolt = <1800000>;
+				regulator-max-microvolt = <3300000>;
+				regulator-boot-on;
+				regulator-always-on;
+			};
+
+			vref_reg: VREFDDR {
+				regulator-name = "VREFDDR";
+				regulator-min-microvolt = <1200000>;
+				regulator-max-microvolt = <1200000>;
+				regulator-boot-on;
+				regulator-always-on;
+			};
+
+			vldo1_reg: LDO1 {
+				regulator-name = "LDO1";
+				regulator-min-microvolt = <750000>;
+				regulator-max-microvolt = <3300000>;
+				regulator-always-on;
+			};
+
+			vldo2_reg: LDO2 {
+				regulator-name = "LDO2";
+				regulator-min-microvolt = <1800000>;
+				regulator-max-microvolt = <3300000>;
+				regulator-always-on;
+			};
+
+			vldo3_reg: LDO3 {
+				regulator-name = "LDO3";
+				regulator-min-microvolt = <750000>;
+				regulator-max-microvolt = <3300000>;
+				regulator-always-on;
+			};
+		};
+	};
 };
 
 &lpuart4 { /* console */
@@ -342,6 +425,14 @@
 	status = "okay";
 };
 
+&heartbeat_rpmsg{
+	status = "disabled";
+};
+
+&rtc_rpmsg{
+	status = "disabled";
+};
+
 &usbotg1 {
 	extcon = <0>, <&extcon_usb1>;
 	srp-disable;
@@ -369,6 +460,8 @@
 	pinctrl-names = "default", "sleep";
 	pinctrl-0 = <&pinctrl_usdhc0>;
 	pinctrl-1 = <&pinctrl_usdhc0>;
+	no-1-8-v;
+	non-removable;
 	status = "okay";
 };
 
diff --git a/arch/arm/boot/dts/imx7ulp.dtsi b/arch/arm/boot/dts/imx7ulp.dtsi
index 981a02d36..39cccfe 100644
--- a/arch/arm/boot/dts/imx7ulp.dtsi
+++ b/arch/arm/boot/dts/imx7ulp.dtsi
@@ -680,11 +680,11 @@
 		};
 	};
 
-	heartbeat-rpmsg {
+	heartbeat_rpmsg: heartbeat-rpmsg {
 		compatible = "fsl,heartbeat-rpmsg";
 	};
 
-	rtc-rpmsg {
+	rtc_rpmsg: rtc-rpmsg {
 		compatible = "fsl,imx-rpmsg-rtc";
 	};
 
-- 
1.9.1

