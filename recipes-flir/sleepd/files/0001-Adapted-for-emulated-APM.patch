From 60d9de069dd14cd5e050dfca8a2f943adac1d9a4 Mon Sep 17 00:00:00 2001
From: Peter Fitger <peter.fitger@flir.se>
Date: Wed, 8 Apr 2015 16:25:33 +0200
Subject: [PATCH] Adapted for emulated APM

Signed-off-by: Peter Fitger <peter.fitger@flir.se>
---
 apm-emulation.h | 52 ++++++++++++++++++++++++++++++++++++++++++++++++++++
 apm.h           |  2 +-
 sleepd.c        | 31 +++++++++++++++++++++++++++++++
 sleepd.h        |  2 +-
 4 files changed, 85 insertions(+), 2 deletions(-)
 create mode 100644 apm-emulation.h

diff --git a/apm-emulation.h b/apm-emulation.h
new file mode 100644
index 0000000..bcaeef9
--- /dev/null
+++ b/apm-emulation.h
@@ -0,0 +1,52 @@
+/* -*- linux-c -*-
+ *
+ * (C) 2003 zecke@handhelds.org
+ *
+ * GPL version 2
+ *
+ * based on arch/arm/kernel/apm.c
+ * factor out the information needed by architectures to provide
+ * apm status
+ */
+#ifndef __LINUX_APM_EMULATION_H
+#define __LINUX_APM_EMULATION_H
+
+#include <linux/apm_bios.h>
+
+/*
+ * This structure gets filled in by the machine specific 'get_power_status'
+ * implementation.  Any fields which are not set default to a safe value.
+ */
+typedef struct apm_info {
+	unsigned char	ac_line_status;
+#define APM_AC_OFFLINE			0
+#define APM_AC_ONLINE			1
+#define APM_AC_BACKUP			2
+#define APM_AC_UNKNOWN			0xff
+
+	unsigned char	battery_status;
+#define APM_BATTERY_STATUS_HIGH		0
+#define APM_BATTERY_STATUS_LOW		1
+#define APM_BATTERY_STATUS_CRITICAL	2
+#define APM_BATTERY_STATUS_CHARGING	3
+#define APM_BATTERY_STATUS_NOT_PRESENT	4
+#define APM_BATTERY_STATUS_UNKNOWN	0xff
+
+	unsigned char	battery_flags;
+#define APM_BATTERY_FLAG_HIGH		(1 << 0)
+#define APM_BATTERY_FLAG_LOW		(1 << 1)
+#define APM_BATTERY_FLAG_CRITICAL	(1 << 2)
+#define APM_BATTERY_FLAG_CHARGING	(1 << 3)
+#define APM_BATTERY_FLAG_NOT_PRESENT	(1 << 7)
+#define APM_BATTERY_FLAG_UNKNOWN	0xff
+
+	int		battery_percentage;
+	int		battery_time;
+	int		using_minutes;
+#define APM_UNITS_MINS			0
+#define APM_UNITS_SECS			1
+#define APM_UNITS_UNKNOWN		-1
+
+} apm_info;
+
+#endif /* __LINUX_APM_EMULATION_H */
diff --git a/apm.h b/apm.h
index bbe5216..1c0674b 100644
--- a/apm.h
+++ b/apm.h
@@ -1,5 +1,5 @@
 #if defined(USE_APM)
-# include <apm.h>
+# include "apm-emulation.h"
 #else
 typedef struct apm_info {
 	char driver_version[10];
diff --git a/sleepd.c b/sleepd.c
index 1969c24..d5ec646 100644
--- a/sleepd.c
+++ b/sleepd.c
@@ -68,6 +68,37 @@ char netdevtx[MAX_NET][44];
 char netdevrx[MAX_NET][44];
 int debug=0;
 
+int apm_exists (void)
+{
+	int fh;
+	fh = open("/proc/apm", O_RDONLY);
+	if (fh < 0)
+		return fh;
+	close(fh);
+	return 0;
+}
+
+void apm_read(apm_info * ai)
+{
+	int fh;
+	char input[100];
+	char units[8];
+	memset(ai, 0, sizeof(*ai));
+	fh = open("/proc/apm", O_RDONLY);
+	if (fh > 0)
+	{
+		read(fh, input, sizeof(input));
+		sscanf(input, "1.13 1.2 0x02 %X %X %X %d%% %d %s",
+			     &ai->ac_line_status,
+			     &ai->battery_status,
+			     &ai->battery_flags,
+			     &ai->battery_percentage,
+			     &ai->battery_time,
+			     &units);
+		close(fh);
+	}
+}
+
 void usage () {
 	fprintf(stderr, "Usage: sleepd [-s command] [-d command] [-u n] [-U n] [-I] [-i n] [-E] [-e filename] [-a] [-l n] [-w] [-n] [-v] [-c n] [-b n] [-A] [-H] [-N [dev] [-t n] [-r n]]\n");
 }
diff --git a/sleepd.h b/sleepd.h
index 5e098b7..35cc449 100644
--- a/sleepd.h
+++ b/sleepd.h
@@ -1,4 +1,4 @@
-#define MAX_IRQS 255
+#define MAX_IRQS 511
 #define MAX_NET 8
 #define INTERRUPTS "/proc/interrupts"
 #define DEFAULT_SLEEP_TIME 10
-- 
2.1.0

