From 59310af1b72ae48b43f4aac50bc3f6d52978dcfb Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ulf=20Palm=C3=A9r?= <ulf.palmer@flir.se>
Date: Wed, 8 Aug 2018 12:58:41 +0200
Subject: [PATCH] preloaded recovery changes

---
 common/autoboot.c            |  9 +++++----
 include/configs/mx7ulp_evk.h | 22 ++++++++++------------
 2 files changed, 15 insertions(+), 16 deletions(-)

diff --git a/common/autoboot.c b/common/autoboot.c
index 80a4f62..e035206 100644
--- a/common/autoboot.c
+++ b/common/autoboot.c
@@ -314,10 +314,10 @@ const char *bootdelay_process(void)
 #if !defined(CONFIG_FSL_FASTBOOT) && defined(is_boot_from_usb)
 	if (is_boot_from_usb()) {
 		disconnect_from_pc();
-		printf("Boot from USB for mfgtools\n");
+		printf("Boot from USB\n");
 		bootdelay = 0;
-		set_default_env("Use default environment for \
-				 mfgtools\n");
+                /*		set_default_env("Use default environment for \
+                                mfgtools\n");*/
 	} else {
 		printf("Normal Boot\n");
 	}
@@ -349,13 +349,14 @@ const char *bootdelay_process(void)
 #endif /* CONFIG_BOOTCOUNT_LIMIT */
 		s = getenv("bootcmd");
 
+        /*
 #if !defined(CONFIG_FSL_FASTBOOT) && defined(is_boot_from_usb)
 	if (is_boot_from_usb()) {
 		s = getenv("bootcmd_mfg");
 		printf("Run bootcmd_mfg: %s\n", s);
 	}
 #endif
-
+        */
 	process_fdt_options(gd->fdt_blob);
 	stored_bootdelay = bootdelay;
 
diff --git a/include/configs/mx7ulp_evk.h b/include/configs/mx7ulp_evk.h
index faac54a..dfcd41c 100644
--- a/include/configs/mx7ulp_evk.h
+++ b/include/configs/mx7ulp_evk.h
@@ -44,7 +44,9 @@
 #define CONFIG_SYS_MMC_IMG_LOAD_PART    1
 
 #define CONFIG_ENV_OFFSET		(14 * SZ_64K)
-#define CONFIG_ENV_IS_IN_MMC
+/* #define CONFIG_ENV_IS_IN_MMC */
+#define CONFIG_ENV_IS_NOWHERE
+
 #define CONFIG_ENV_SIZE			SZ_8K
 
 #define CONFIG_CMD_FAT
@@ -193,24 +195,20 @@
 						"bootz; " \
 					"else " \
 						"echo WARN: Cannot load the DT; " \
-					"fi; " \
+					"fi; " \ 
 				"fi; " \
 			"else " \
 				"bootz; " \
 			"fi; " \
 		"fi;\0" \
+                "recargs=setenv bootargs console=${console},${baudrate} " \
+                "root=/dev/ram0\0"                \
+                "recboot=echo Booting preloaded recovery...; "\
+                "run recargs; " \
+                "bootz ${loadaddr} ${initrd_addr} ${fdt_addr}; \0" \
 
 #define CONFIG_BOOTCOMMAND \
-	   "mmc dev ${mmcdev}; if mmc rescan; then " \
-		   "if run loadbootscript; then " \
-			   "run bootscript; " \
-		   "else " \
-			   "if run loadimage; then " \
-				   "run mmcboot; " \
-			   "else run netboot; " \
-			   "fi; " \
-		   "fi; " \
-	   "fi"
+	"run recboot"
 
 #define CONFIG_SYS_HZ			1000
 #define CONFIG_SYS_LOAD_ADDR		CONFIG_LOADADDR
-- 
1.9.1

